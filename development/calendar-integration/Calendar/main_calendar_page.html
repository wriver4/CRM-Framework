<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <title>CRM Calendar - Next Actions & Task Management</title>

    <!-- FRAMEWORK INTEGRATION NOTES FOR DEVELOPERS:
         1. This HTML will be converted to PHP template following CRM framework patterns
         2. Replace hardcoded text with translation keys from /admin/languages/
         3. Use framework's authentication system: $not->loggedin()
         4. Follow template sequence: HEADER → BODY → NAV → SECTIONOPEN → content → SECTIONCLOSE → FOOTER
         5. Move CSS to /public_html/assets/css/calendar.css 
         6. Move JavaScript to /public_html/assets/js/calendar.js
         7. Use conditional loading in header.php and footer.php templates
    -->

    <!-- Bootstrap 5 CSS (Framework Standard) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- FullCalendar CSS (CDN First, Then Local Customizations) -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
          rel="stylesheet">

    <!-- Font Awesome Icons (Framework Standard) -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .fc-event {
            cursor: pointer;
            border-radius: 4px;
        }

        .task-type-badge {
            font-size: 0.75rem;
            margin-right: 5px;
        }

        .priority-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .priority-high {
            background-color: #dc3545;
        }

        .priority-medium {
            background-color: #fd7e14;
        }

        .priority-low {
            background-color: #20c997;
        }

        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .stats-card {
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        #calendar {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .task-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
    </style>
</head>

<body class="bg-light">
    <!-- 
         CALENDAR HEADER SECTION
         Developer Notes:
         - Replace hardcoded text with translation keys: $lang['calendar_title'], $lang['calendar_subtitle']
         - "New Task" button creates Next Actions that can be scheduled or unscheduled
         - Priority system: 1-10 scale (matches database calendar_events.priority field)
    -->
    <div class="calendar-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-calendar-alt me-3"></i>CRM Calendar - Next Actions</h1>
                    <p class="mb-0 mt-2">Manage your next actions: calls, emails, meetings, and follow-ups with priority
                        levels</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg"
                            data-bs-toggle="modal"
                            data-bs-target="#nextActionModal">
                        <i class="fas fa-plus me-2"></i>New Next Action
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-phone fa-2x text-primary"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">Calls Today</div>
                                <div class="h4 mb-0"
                                     id="calls-today">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-envelope fa-2x text-success"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">Emails Today</div>
                                <div class="h4 mb-0"
                                     id="emails-today">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-users fa-2x text-warning"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">Meetings</div>
                                <div class="h4 mb-0"
                                     id="meetings-today">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">High Priority</div>
                                <div class="h4 mb-0"
                                     id="high-priority">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="row">
            <div class="col-12">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal fade"
         id="taskModal"
         tabindex="-1"
         aria-labelledby="taskModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"
                        id="taskModalLabel">Add New Task</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="title"
                                           class="form-label">Task Title *</label>
                                    <input type="text"
                                           class="form-control"
                                           id="title"
                                           name="title"
                                           required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="task_type"
                                           class="form-label">Task Type *</label>
                                    <select class="form-select"
                                            id="task_type"
                                            name="task_type"
                                            required>
                                        <option value="call">Call</option>
                                        <option value="email">Email</option>
                                        <option value="meeting">Meeting</option>
                                        <option value="follow_up">Follow Up</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_datetime"
                                           class="form-label">Start Date & Time *</label>
                                    <input type="datetime-local"
                                           class="form-control"
                                           id="start_datetime"
                                           name="start_datetime"
                                           required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_datetime"
                                           class="form-label">End Date & Time</label>
                                    <input type="datetime-local"
                                           class="form-control"
                                           id="end_datetime"
                                           name="end_datetime">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="priority"
                                           class="form-label">Priority</label>
                                    <select class="form-select"
                                            id="priority"
                                            name="priority">
                                        <option value="low">Low</option>
                                        <option value="medium"
                                                selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status"
                                           class="form-label">Status</label>
                                    <select class="form-select"
                                            id="status"
                                            name="status">
                                        <option value="pending"
                                                selected>Pending</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="contact_name"
                                   class="form-label">Contact Name</label>
                            <input type="text"
                                   class="form-control"
                                   id="contact_name"
                                   name="contact_name">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contact_phone"
                                           class="form-label">Contact Phone</label>
                                    <input type="tel"
                                           class="form-control"
                                           id="contact_phone"
                                           name="contact_phone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contact_email"
                                           class="form-label">Contact Email</label>
                                    <input type="email"
                                           class="form-control"
                                           id="contact_email"
                                           name="contact_email">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description"
                                   class="form-label">Description</label>
                            <textarea class="form-control"
                                      id="description"
                                      name="description"
                                      rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="notes"
                                   class="form-label">Notes</label>
                            <textarea class="form-control"
                                      id="notes"
                                      name="notes"
                                      rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">Cancel</button>
                    <button type="button"
                            class="btn btn-danger"
                            id="deleteTaskBtn"
                            style="display: none;">Delete</button>
                    <button type="button"
                            class="btn btn-primary"
                            id="saveTaskBtn">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal fade"
         id="eventDetailModal"
         tabindex="-1"
         aria-labelledby="eventDetailModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"
                        id="eventDetailModalLabel">Task Details</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body"
                     id="eventDetailContent">
                    <!-- Event details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">Close</button>
                    <button type="button"
                            class="btn btn-primary"
                            id="editEventBtn">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let calendar;
            let currentEditingId = null;

            // Initialize calendar
            initializeCalendar();

            // Load stats
            loadStats();

            function initializeCalendar () {
                const calendarEl = document.getElementById('calendar');

                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                    },
                    events: function (info, successCallback, failureCallback) {
                        fetch(`api/tasks.php?start=${info.startStr}&end=${info.endStr}`)
                            .then(response => response.json())
                            .then(data => successCallback(data))
                            .catch(error => {
                                console.error('Error loading events:', error);
                                failureCallback(error);
                            });
                    },
                    eventClick: function (info) {
                        showEventDetails(info.event);
                    },
                    dateClick: function (info) {
                        openTaskModal(info.dateStr);
                    },
                    eventDrop: function (info) {
                        updateEventDateTime(info.event);
                    },
                    eventResize: function (info) {
                        updateEventDateTime(info.event);
                    },
                    editable: true,
                    droppable: true,
                    height: 'auto',
                    nowIndicator: true,
                    dayMaxEvents: 3,
                    moreLinkClick: 'listDay'
                });

                calendar.render();
            }

            function showEventDetails (event) {
                const props = event.extendedProps;
                const priority = props.priority || 'medium';
                const status = props.status || 'pending';

                const priorityColor = {
                    'high': 'danger',
                    'medium': 'warning',
                    'low': 'success'
                }[priority];

                const statusColor = {
                    'pending': 'warning',
                    'completed': 'success',
                    'cancelled': 'danger'
                }[status];

                const content = `
                    <div class="task-details">
                        <div class="row mb-3">
                            <div class="col-6">
                                <span class="badge bg-primary">${props.task_type.toUpperCase()}</span>
                            </div>
                            <div class="col-6 text-end">
                                <span class="badge bg-${priorityColor}">${priority.toUpperCase()}</span>
                                <span class="badge bg-${statusColor}">${status.toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-clock me-2"></i>Schedule</h6>
                        <p><strong>Start:</strong> ${new Date(event.start).toLocaleString()}</p>
                        ${event.end ? `<p><strong>End:</strong> ${new Date(event.end).toLocaleString()}</p>` : ''}
                        
                        ${props.contact_name ? `
                            <h6 class="mt-3"><i class="fas fa-user me-2"></i>Contact Information</h6>
                            <p><strong>Name:</strong> ${props.contact_name}</p>
                            ${props.contact_phone ? `<p><strong>Phone:</strong> <a href="tel:${props.contact_phone}">${props.contact_phone}</a></p>` : ''}
                            ${props.contact_email ? `<p><strong>Email:</strong> <a href="mailto:${props.contact_email}">${props.contact_email}</a></p>` : ''}
                        ` : ''}
                        
                        ${props.description ? `
                            <h6 class="mt-3"><i class="fas fa-align-left me-2"></i>Description</h6>
                            <p>${props.description}</p>
                        ` : ''}
                        
                        ${props.notes ? `
                            <h6 class="mt-3"><i class="fas fa-sticky-note me-2"></i>Notes</h6>
                            <p>${props.notes}</p>
                        ` : ''}
                    </div>
                `;

                document.getElementById('eventDetailContent').innerHTML = content;

                // Store event ID for editing
                document.getElementById('editEventBtn').onclick = function () {
                    currentEditingId = event.id;
                    populateFormForEdit(event);
                    bootstrap.Modal.getInstance(document.getElementById('eventDetailModal')).hide();
                    new bootstrap.Modal(document.getElementById('taskModal')).show();
                };

                new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
            }

            function openTaskModal (dateStr = null) {
                currentEditingId = null;
                document.getElementById('taskForm').reset();
                document.getElementById('taskModalLabel').textContent = 'Add New Task';
                document.getElementById('deleteTaskBtn').style.display = 'none';

                if (dateStr) {
                    // Set default date/time
                    const date = new Date(dateStr);
                    const hours = date.getHours();
                    if (hours < 9) date.setHours(9, 0); // Default to 9 AM
                    else if (hours > 17) date.setHours(17, 0); // Default to 5 PM

                    document.getElementById('start_datetime').value = date.toISOString().slice(0, 16);

                    // Set end time 30 minutes later
                    const endDate = new Date(date.getTime() + 30 * 60000);
                    document.getElementById('end_datetime').value = endDate.toISOString().slice(0, 16);
                }

                new bootstrap.Modal(document.getElementById('taskModal')).show();
            }

            function populateFormForEdit (event) {
                const props = event.extendedProps;

                document.getElementById('taskModalLabel').textContent = 'Edit Task';
                document.getElementById('deleteTaskBtn').style.display = 'inline-block';

                // Extract title without contact name
                let title = event.title;
                if (props.contact_name) {
                    title = title.replace(` - ${props.contact_name}`, '');
                }

                document.getElementById('title').value = title;
                document.getElementById('task_type').value = props.task_type;
                document.getElementById('priority').value = props.priority;
                document.getElementById('status').value = props.status;
                document.getElementById('contact_name').value = props.contact_name || '';
                document.getElementById('contact_phone').value = props.contact_phone || '';
                document.getElementById('contact_email').value = props.contact_email || '';
                document.getElementById('description').value = props.description || '';
                document.getElementById('notes').value = props.notes || '';

                if (event.start) {
                    document.getElementById('start_datetime').value = new Date(event.start).toISOString().slice(0, 16);
                }
                if (event.end) {
                    document.getElementById('end_datetime').value = new Date(event.end).toISOString().slice(0, 16);
                }
            }

            function updateEventDateTime (event) {
                const data = {
                    title: event.title.split(' - ')[0], // Remove contact name from title
                    start_datetime: event.start.toISOString().slice(0, 19).replace('T', ' '),
                    end_datetime: event.end ? event.end.toISOString().slice(0, 19).replace('T', ' ') : null,
                    task_type: event.extendedProps.task_type,
                    priority: event.extendedProps.priority,
                    status: event.extendedProps.status,
                    contact_name: event.extendedProps.contact_name,
                    contact_phone: event.extendedProps.contact_phone,
                    contact_email: event.extendedProps.contact_email,
                    description: event.extendedProps.description,
                    notes: event.extendedProps.notes
                };

                fetch(`api/tasks.php?id=${event.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showToast('Task updated successfully', 'success');
                            loadStats();
                        } else {
                            showToast('Failed to update task', 'danger');
                            event.revert();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Error updating task', 'danger');
                        event.revert();
                    });
            }

            function saveTask () {
                const form = document.getElementById('taskForm');
                const formData = new FormData(form);

                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // Convert datetime-local to MySQL format
                if (data.start_datetime) {
                    data.start_datetime = data.start_datetime.replace('T', ' ');
                }
                if (data.end_datetime) {
                    data.end_datetime = data.end_datetime.replace('T', ' ');
                }

                const url = currentEditingId ? `api/tasks.php?id=${currentEditingId}` : 'api/tasks.php';
                const method = currentEditingId ? 'PUT' : 'POST';

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showToast(currentEditingId ? 'Task updated successfully' : 'Task created successfully', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                            calendar.refetchEvents();
                            loadStats();
                        } else {
                            showToast(result.error || 'Failed to save task', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Error saving task', 'danger');
                    });
            }

            function deleteTask () {
                if (!currentEditingId) return;

                if (confirm('Are you sure you want to delete this task?')) {
                    fetch(`api/tasks.php?id=${currentEditingId}`, {
                        method: 'DELETE'
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                showToast('Task deleted successfully', 'success');
                                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                                calendar.refetchEvents();
                                loadStats();
                            } else {
                                showToast('Failed to delete task', 'danger');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast('Error deleting task', 'danger');
                        });
                }
            }

            function loadStats () {
                fetch('api/tasks.php')
                    .then(response => response.json())
                    .then(events => {
                        const today = new Date().toDateString();

                        let callsToday = 0;
                        let emailsToday = 0;
                        let meetingsToday = 0;
                        let highPriority = 0;

                        events.forEach(event => {
                            const eventDate = new Date(event.start).toDateString();

                            if (eventDate === today) {
                                switch (event.extendedProps.task_type) {
                                    case 'call':
                                        callsToday++;
                                        break;
                                    case 'email':
                                        emailsToday++;
                                        break;
                                    case 'meeting':
                                        meetingsToday++;
                                        break;
                                }
                            }

                            if (event.extendedProps.priority === 'high') {
                                highPriority++;
                            }
                        });

                        document.getElementById('calls-today').textContent = callsToday;
                        document.getElementById('emails-today').textContent = emailsToday;
                        document.getElementById('meetings-today').textContent = meetingsToday;
                        document.getElementById('high-priority').textContent = highPriority;
                    })
                    .catch(error => console.error('Error loading stats:', error));
            }

            function showToast (message, type = 'info') {
                // Create toast container if it doesn't exist
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    toastContainer.style.zIndex = '9999';
                    document.body.appendChild(toastContainer);
                }

                const toastId = 'toast-' + Date.now();
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                toastContainer.insertAdjacentHTML('beforeend', toastHTML);

                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement);
                toast.show();

                // Remove toast element after it's hidden
                toastElement.addEventListener('hidden.bs.toast', function () {
                    toastElement.remove();
                });
            }

            // Event listeners
            document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
            document.getElementById('deleteTaskBtn').addEventListener('click', deleteTask);

            // Reset form when modal is hidden
            document.getElementById('taskModal').addEventListener('hidden.bs.modal', function () {
                document.getElementById('taskForm').reset();
                document.getElementById('taskForm').classList.remove('was-validated');
                currentEditingId = null;
            });
        });
    </script>
</body>

</html>