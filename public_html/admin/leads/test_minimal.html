<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <title>Minimal Delete Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        rel="stylesheet">
</head>

<body>
  <div class="container mt-4">
    <h1>Minimal Delete Test</h1>

    <div class="alert alert-warning">
      <strong>Important:</strong> This test uses fake data and will test the AJAX endpoint with invalid note IDs.
      Open browser developer tools (F12) and watch the Console tab.
    </div>

    <div id="test-results"></div>

    <!-- Fake timeline item for testing -->
    <div class="timeline-item mb-4"
         style="border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; background: #f8f9fa;">
      <div class="timeline-content">
        <div class="note-text mb-2">
          <strong>FAKE NOTE FOR TESTING</strong><br>
          This is a fake note used to test the delete functionality.
          It will test the AJAX call but won't actually delete anything.
        </div>
        <div class="d-flex justify-content-between align-items-end">
          <small class="text-muted">Test User - Just now</small>
          <button type="button"
                  class="btn btn-outline-danger btn-sm delete-note-btn"
                  data-note-id="999999"
                  data-lead-id="1"
                  title="Delete this note">
            <i class="fa-solid fa-trash fa-sm"></i> Test Delete
          </button>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <button type="button"
              class="btn btn-primary"
              onclick="runTests()">Run All Tests</button>
      <button type="button"
              class="btn btn-info"
              onclick="testDOMOnly()">Test DOM Only</button>
      <button type="button"
              class="btn btn-warning"
              onclick="testAjaxOnly()">Test AJAX Only</button>
    </div>

    <div class="mt-4">
      <h3>Test Results</h3>
      <div id="results-container"
           class="border p-3 bg-light"></div>
    </div>
  </div>

  <script>
    let testResults = [];

    function logResult (test, status, message) {
      testResults.push({ test, status, message, timestamp: new Date().toLocaleTimeString() });
      updateResultsDisplay();
      console.log(`[${status}] ${test}: ${message}`);
    }

    function updateResultsDisplay () {
      const container = document.getElementById('results-container');
      container.innerHTML = testResults.map(result =>
        `<div class="mb-2">
                    <span class="badge bg-${result.status === 'PASS' ? 'success' : result.status === 'FAIL' ? 'danger' : 'warning'}">${result.status}</span>
                    <strong>${result.test}</strong>: ${result.message}
                    <small class="text-muted">(${result.timestamp})</small>
                </div>`
      ).join('');
    }

    function runTests () {
      testResults = [];
      logResult('INIT', 'INFO', 'Starting comprehensive tests...');

      // Test 1: DOM Elements
      testDOMElements();

      // Test 2: Event Handlers
      setTimeout(() => testEventHandlers(), 100);

      // Test 3: AJAX Endpoint
      setTimeout(() => testAjaxEndpoint(), 200);
    }

    function testDOMElements () {
      logResult('DOM', 'INFO', 'Testing DOM elements...');

      const deleteButtons = document.querySelectorAll('.delete-note-btn');
      if (deleteButtons.length > 0) {
        logResult('DOM', 'PASS', `Found ${deleteButtons.length} delete button(s)`);
      } else {
        logResult('DOM', 'FAIL', 'No delete buttons found');
        return;
      }

      const timelineItems = document.querySelectorAll('.timeline-item');
      if (timelineItems.length > 0) {
        logResult('DOM', 'PASS', `Found ${timelineItems.length} timeline item(s)`);
      } else {
        logResult('DOM', 'FAIL', 'No timeline items found');
        return;
      }

      // Test button attributes
      const firstButton = deleteButtons[0];
      const noteId = firstButton.getAttribute('data-note-id');
      const leadId = firstButton.getAttribute('data-lead-id');

      if (noteId && leadId) {
        logResult('DOM', 'PASS', `Button has data attributes: note-id=${noteId}, lead-id=${leadId}`);
      } else {
        logResult('DOM', 'FAIL', 'Button missing data attributes');
      }

      // Test closest() method
      const noteElement = firstButton.closest('.timeline-item');
      if (noteElement) {
        logResult('DOM', 'PASS', 'closest() method works correctly');
      } else {
        logResult('DOM', 'FAIL', 'closest() method failed');
      }
    }

    function testEventHandlers () {
      logResult('EVENTS', 'INFO', 'Testing event handlers...');

      // Test if click event is properly attached
      const button = document.querySelector('.delete-note-btn');
      if (button) {
        // Simulate click without confirmation
        const clickEvent = new Event('click', { bubbles: true });
        button.dispatchEvent(clickEvent);
        logResult('EVENTS', 'PASS', 'Click event dispatched successfully');
      } else {
        logResult('EVENTS', 'FAIL', 'No button found for event test');
      }
    }

    function testAjaxEndpoint () {
      logResult('AJAX', 'INFO', 'Testing AJAX endpoint...');

      const formData = new FormData();
      formData.append('note_id', 999999);
      formData.append('lead_id', 1);

      fetch('/admin/leads/delete_note.php', {
        method: 'POST',
        body: formData
      })
        .then(response => {
          logResult('AJAX', 'PASS', `Response received with status: ${response.status}`);
          return response.text();
        })
        .then(text => {
          logResult('AJAX', 'INFO', `Raw response: ${text.substring(0, 100)}...`);

          try {
            const data = JSON.parse(text);
            logResult('AJAX', 'PASS', 'Valid JSON response received');
            logResult('AJAX', 'INFO', `Response data: ${JSON.stringify(data)}`);
          } catch (e) {
            logResult('AJAX', 'FAIL', `Invalid JSON: ${e.message}`);
          }
        })
        .catch(error => {
          logResult('AJAX', 'FAIL', `Network error: ${error.message}`);
        });
    }

    function testDOMOnly () {
      logResult('DOM-ONLY', 'INFO', 'Testing DOM manipulation only...');

      const button = document.querySelector('.delete-note-btn');
      const noteElement = button.closest('.timeline-item');

      if (noteElement) {
        // Test visual feedback
        noteElement.style.backgroundColor = '#fff3cd';
        noteElement.style.borderColor = '#ffeaa7';
        logResult('DOM-ONLY', 'PASS', 'Visual feedback applied');

        setTimeout(() => {
          noteElement.style.transition = 'all 0.5s ease-out';
          noteElement.style.opacity = '0.5';
          noteElement.style.transform = 'translateX(-10px)';
          logResult('DOM-ONLY', 'PASS', 'Animation applied');

          setTimeout(() => {
            // Reset styles
            noteElement.style.backgroundColor = '';
            noteElement.style.borderColor = '';
            noteElement.style.opacity = '';
            noteElement.style.transform = '';
            noteElement.style.transition = '';
            logResult('DOM-ONLY', 'PASS', 'Styles reset - DOM manipulation works!');
          }, 1000);
        }, 100);
      } else {
        logResult('DOM-ONLY', 'FAIL', 'Could not find note element');
      }
    }

    function testAjaxOnly () {
      testAjaxEndpoint();
    }

    // Add click handler for delete buttons
    document.addEventListener('click', function (e) {
      if (e.target.closest('.delete-note-btn')) {
        e.preventDefault();

        const button = e.target.closest('.delete-note-btn');
        const noteId = button.getAttribute('data-note-id');
        const leadId = button.getAttribute('data-lead-id');

        logResult('CLICK', 'INFO', `Delete button clicked: note-id=${noteId}, lead-id=${leadId}`);

        if (confirm('This is a test. The note will not actually be deleted. Continue?')) {
          logResult('CLICK', 'PASS', 'User confirmed deletion');

          // Test the full delete process
          testFullDeleteProcess(noteId, leadId, button);
        } else {
          logResult('CLICK', 'INFO', 'User cancelled deletion');
        }
      }
    });

    function testFullDeleteProcess (noteId, leadId, button) {
      logResult('FULL-DELETE', 'INFO', 'Starting full delete process test...');

      // Disable button
      button.disabled = true;
      const originalContent = button.innerHTML;
      button.innerHTML = '<i class="fa-solid fa-spinner fa-spin fa-sm"></i> Testing...';

      const noteElement = button.closest('.timeline-item');

      // Test AJAX call
      const formData = new FormData();
      formData.append('note_id', noteId);
      formData.append('lead_id', leadId);

      fetch('/admin/leads/delete_note.php', {
        method: 'POST',
        body: formData
      })
        .then(response => {
          logResult('FULL-DELETE', 'PASS', `AJAX request completed: ${response.status}`);
          return response.text();
        })
        .then(text => {
          try {
            const data = JSON.parse(text);
            logResult('FULL-DELETE', 'PASS', 'JSON parsed successfully');

            if (data.success === false) {
              logResult('FULL-DELETE', 'PASS', 'Expected error response received');

              // Test DOM manipulation (fake success)
              noteElement.style.backgroundColor = '#d4edda';
              noteElement.style.borderColor = '#c3e6cb';

              setTimeout(() => {
                noteElement.style.transition = 'all 0.5s ease-out';
                noteElement.style.opacity = '0';
                noteElement.style.transform = 'translateX(-50px)';

                setTimeout(() => {
                  // Don't actually remove, just reset
                  noteElement.style.backgroundColor = '';
                  noteElement.style.borderColor = '';
                  noteElement.style.opacity = '';
                  noteElement.style.transform = '';
                  noteElement.style.transition = '';

                  logResult('FULL-DELETE', 'PASS', 'DOM manipulation test completed successfully!');

                  // Re-enable button
                  button.disabled = false;
                  button.innerHTML = originalContent;

                }, 500);
              }, 100);

            } else {
              logResult('FULL-DELETE', 'WARN', 'Unexpected success response');
            }

          } catch (e) {
            logResult('FULL-DELETE', 'FAIL', `JSON parse error: ${e.message}`);

            // Re-enable button
            button.disabled = false;
            button.innerHTML = originalContent;
          }
        })
        .catch(error => {
          logResult('FULL-DELETE', 'FAIL', `Network error: ${error.message}`);

          // Re-enable button
          button.disabled = false;
          button.innerHTML = originalContent;
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
      logResult('INIT', 'PASS', 'Page loaded successfully');
      console.log('Minimal delete test page ready');
    });
  </script>
</body>

</html>