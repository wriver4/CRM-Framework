<?php

/**
 * SMTP Configuration Management
 * Manage SMTP servers for sending outgoing emails
 */

// Load system configuration
require_once dirname($_SERVER['DOCUMENT_ROOT']) . '/config/system.php';

// Security check
$security = new Security();
$security->check_user_permissions('admin', 'read');

// Direct routing variables - these determine page navigation and template inclusion
$dir = 'admin';
$subdir = 'email';
$sub_subdir = '';
$sub_sub_subdir = '';
$page = 'smtp_config';
$table_page = true;

// Set display variables
$title = 'SMTP Configuration';
$title_icon = '<i class="fa fa-paper-plane"></i>';

// Load language file
$lang = include LANG . '/en.php';

// Initialize database
$database = new Database();
$pdo = $database->dbcrm();

// Handle actions
$action = $_GET['action'] ?? 'list';
$id = (int)($_GET['id'] ?? 0);

// Process form submissions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $nonce = new Nonce();
    
    if (!$nonce->validate($_POST['nonce'] ?? '')) {
        $message = "Invalid security token. Please try again.";
        $messageType = "danger";
    } else {
        $config_name = trim($_POST['config_name'] ?? '');
        $user_id = !empty($_POST['user_id']) ? (int)$_POST['user_id'] : null;
        $smtp_host = trim($_POST['smtp_host'] ?? '');
        $smtp_port = (int)($_POST['smtp_port'] ?? 587);
        $smtp_encryption = $_POST['smtp_encryption'] ?? 'tls';
        $smtp_username = trim($_POST['smtp_username'] ?? '');
        $smtp_password = trim($_POST['smtp_password'] ?? '');
        $from_email = trim($_POST['from_email'] ?? '');
        $from_name = trim($_POST['from_name'] ?? '');
        $reply_to_email = trim($_POST['reply_to_email'] ?? '');
        $is_default = isset($_POST['is_default']) ? 1 : 0;
        $is_active = isset($_POST['is_active']) ? 1 : 0;
        
        try {
            if ($action === 'add') {
                // If setting as default, unset other defaults for this user
                if ($is_default) {
                    if ($user_id) {
                        $stmt = $pdo->prepare("UPDATE smtp_config SET is_default = 0 WHERE user_id = ?");
                        $stmt->execute([$user_id]);
                    } else {
                        $stmt = $pdo->prepare("UPDATE smtp_config SET is_default = 0 WHERE user_id IS NULL");
                        $stmt->execute();
                    }
                }
                
                // Encrypt password
                $encrypted_password = base64_encode($smtp_password);
                
                $stmt = $pdo->prepare("INSERT INTO smtp_config 
                    (config_name, user_id, smtp_host, smtp_port, smtp_encryption, smtp_username, smtp_password, 
                     from_email, from_name, reply_to_email, is_default, is_active) 
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
                
                $stmt->execute([
                    $config_name,
                    $user_id,
                    $smtp_host,
                    $smtp_port,
                    $smtp_encryption,
                    $smtp_username,
                    $encrypted_password,
                    $from_email,
                    $from_name,
                    $reply_to_email,
                    $is_default,
                    $is_active
                ]);
                
                $message = "SMTP configuration added successfully.";
                $messageType = "success";
                $action = 'list';
                
            } elseif ($action === 'edit' && $id > 0) {
                // If setting as default, unset other defaults for this user
                if ($is_default) {
                    if ($user_id) {
                        $stmt = $pdo->prepare("UPDATE smtp_config SET is_default = 0 WHERE user_id = ? AND id != ?");
                        $stmt->execute([$user_id, $id]);
                    } else {
                        $stmt = $pdo->prepare("UPDATE smtp_config SET is_default = 0 WHERE user_id IS NULL AND id != ?");
                        $stmt->execute([$id]);
                    }
                }
                
                // Update configuration
                if ($smtp_password) {
                    // Update with new password
                    $encrypted_password = base64_encode($smtp_password);
                    $stmt = $pdo->prepare("UPDATE smtp_config SET 
                        config_name = ?, user_id = ?, smtp_host = ?, smtp_port = ?, 
                        smtp_encryption = ?, smtp_username = ?, smtp_password = ?, 
                        from_email = ?, from_name = ?, reply_to_email = ?, 
                        is_default = ?, is_active = ?, updated_at = NOW() 
                        WHERE id = ?");
                    
                    $stmt->execute([
                        $config_name,
                        $user_id,
                        $smtp_host,
                        $smtp_port,
                        $smtp_encryption,
                        $smtp_username,
                        $encrypted_password,
                        $from_email,
                        $from_name,
                        $reply_to_email,
                        $is_default,
                        $is_active,
                        $id
                    ]);
                } else {
                    // Update without changing password
                    $stmt = $pdo->prepare("UPDATE smtp_config SET 
                        config_name = ?, user_id = ?, smtp_host = ?, smtp_port = ?, 
                        smtp_encryption = ?, smtp_username = ?, 
                        from_email = ?, from_name = ?, reply_to_email = ?, 
                        is_default = ?, is_active = ?, updated_at = NOW() 
                        WHERE id = ?");
                    
                    $stmt->execute([
                        $config_name,
                        $user_id,
                        $smtp_host,
                        $smtp_port,
                        $smtp_encryption,
                        $smtp_username,
                        $from_email,
                        $from_name,
                        $reply_to_email,
                        $is_default,
                        $is_active,
                        $id
                    ]);
                }
                
                $message = "SMTP configuration updated successfully.";
                $messageType = "success";
                $action = 'list';
            }
        } catch (Exception $e) {
            $message = "Error: " . $e->getMessage();
            $messageType = "danger";
        }
    }
}

// Handle delete action
if ($action === 'delete' && $id > 0) {
    try {
        $stmt = $pdo->prepare("DELETE FROM smtp_config WHERE id = ?");
        $stmt->execute([$id]);
        
        $message = "SMTP configuration deleted successfully.";
        $messageType = "success";
        $action = 'list';
    } catch (Exception $e) {
        $message = "Error deleting configuration: " . $e->getMessage();
        $messageType = "danger";
    }
}

// Get configuration data for editing
$config_data = null;
if ($action === 'edit' && $id > 0) {
    $stmt = $pdo->prepare("SELECT * FROM smtp_config WHERE id = ?");
    $stmt->execute([$id]);
    $config_data = $stmt->fetch();
    
    if (!$config_data) {
        $message = "Configuration not found.";
        $messageType = "danger";
        $action = 'list';
    }
}

// Get all configurations for listing
if ($action === 'list') {
    $stmt = $pdo->prepare("
        SELECT sc.*, u.full_name as user_name 
        FROM smtp_config sc 
        LEFT JOIN users u ON sc.user_id = u.id 
        ORDER BY sc.user_id IS NULL DESC, u.full_name, sc.config_name
    ");
    $stmt->execute();
    $configs = $stmt->fetchAll();
}

// Get all users for dropdown
$stmt = $pdo->prepare("SELECT id, full_name FROM users ORDER BY full_name");
$stmt->execute();
$users = $stmt->fetchAll();

// Generate nonce for forms
$nonce = new Nonce();
$nonce_token = $nonce->create('smtp_config');

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMTP Configuration - <?php echo TABTITLEPREFIX; ?></title>
    <?php include HEADER; ?>
</head>
<body>
    <?php include NAV; ?>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fa fa-paper-plane me-2"></i>SMTP Configuration</h2>
                    <?php if ($action === 'list'): ?>
                    <a href="?action=add" class="btn btn-primary">
                        <i class="fa fa-plus me-1"></i>Add Configuration
                    </a>
                    <?php else: ?>
                    <a href="?" class="btn btn-secondary">
                        <i class="fa fa-arrow-left me-1"></i>Back to List
                    </a>
                    <?php endif; ?>
                </div>

                <?php if (isset($message)): ?>
                <div class="alert alert-<?php echo $messageType; ?> alert-dismissible fade show" role="alert">
                    <?php echo htmlspecialchars($message); ?>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <?php endif; ?>

                <?php if ($action === 'list'): ?>
                <!-- Configurations List -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">SMTP Servers</h5>
                    </div>
                    <div class="card-body">
                        <?php if (empty($configs)): ?>
                        <div class="text-center py-4">
                            <i class="fa fa-paper-plane fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No SMTP configurations found.</p>
                            <a href="?action=add" class="btn btn-primary">Add First Configuration</a>
                        </div>
                        <?php else: ?>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Configuration Name</th>
                                        <th>User</th>
                                        <th>SMTP Server</th>
                                        <th>From Email</th>
                                        <th>Default</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($configs as $config): ?>
                                    <tr>
                                        <td>
                                            <strong><?php echo htmlspecialchars($config['config_name']); ?></strong>
                                        </td>
                                        <td>
                                            <?php if ($config['user_id']): ?>
                                                <span class="badge bg-info"><?php echo htmlspecialchars($config['user_name']); ?></span>
                                            <?php else: ?>
                                                <span class="badge bg-secondary">System Default</span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <?php echo htmlspecialchars($config['smtp_host']); ?>:<?php echo $config['smtp_port']; ?>
                                            <small class="text-muted">(<?php echo strtoupper($config['smtp_encryption']); ?>)</small>
                                        </td>
                                        <td><?php echo htmlspecialchars($config['from_email']); ?></td>
                                        <td>
                                            <?php if ($config['is_default']): ?>
                                                <span class="badge bg-primary">Default</span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <?php if ($config['is_active']): ?>
                                                <span class="badge bg-success">Active</span>
                                            <?php else: ?>
                                                <span class="badge bg-warning">Inactive</span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="?action=edit&id=<?php echo $config['id']; ?>" class="btn btn-outline-primary">
                                                    <i class="fa fa-edit"></i>
                                                </a>
                                                <a href="?action=delete&id=<?php echo $config['id']; ?>" 
                                                   class="btn btn-outline-danger"
                                                   onclick="return confirm('Delete this SMTP configuration?')">
                                                    <i class="fa fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>

                <?php elseif ($action === 'add' || $action === 'edit'): ?>
                <!-- Add/Edit Form -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><?php echo $action === 'add' ? 'Add' : 'Edit'; ?> SMTP Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            <input type="hidden" name="nonce" value="<?php echo $nonce_token; ?>">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="config_name" class="form-label">Configuration Name *</label>
                                        <input type="text" name="config_name" id="config_name" class="form-control" 
                                               value="<?php echo htmlspecialchars($config_data['config_name'] ?? ''); ?>" 
                                               placeholder="e.g., Main SMTP Server" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="user_id" class="form-label">User (Optional)</label>
                                        <select name="user_id" id="user_id" class="form-select">
                                            <option value="">System Default (All Users)</option>
                                            <?php foreach ($users as $user): ?>
                                            <option value="<?php echo $user['id']; ?>" 
                                                    <?php echo ($config_data['user_id'] ?? '') == $user['id'] ? 'selected' : ''; ?>>
                                                <?php echo htmlspecialchars($user['full_name']); ?>
                                            </option>
                                            <?php endforeach; ?>
                                        </select>
                                        <small class="form-text text-muted">Leave empty for system-wide default</small>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">
                            <h6 class="mb-3">SMTP Server Settings</h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtp_host" class="form-label">SMTP Host *</label>
                                        <input type="text" name="smtp_host" id="smtp_host" class="form-control" 
                                               value="<?php echo htmlspecialchars($config_data['smtp_host'] ?? ''); ?>" 
                                               placeholder="smtp.example.com" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="smtp_port" class="form-label">SMTP Port *</label>
                                        <input type="number" name="smtp_port" id="smtp_port" class="form-control" 
                                               value="<?php echo htmlspecialchars($config_data['smtp_port'] ?? '587'); ?>" 
                                               min="1" max="65535" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="smtp_encryption" class="form-label">Encryption *</label>
                                        <select name="smtp_encryption" id="smtp_encryption" class="form-select" required>
                                            <option value="tls" <?php echo ($config_data['smtp_encryption'] ?? 'tls') === 'tls' ? 'selected' : ''; ?>>TLS (Port 587)</option>
                                            <option value="ssl" <?php echo ($config_data['smtp_encryption'] ?? '') === 'ssl' ? 'selected' : ''; ?>>SSL (Port 465)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtp_username" class="form-label">SMTP Username *</label>
                                        <input type="text" name="smtp_username" id="smtp_username" class="form-control" 
                                               value="<?php echo htmlspecialchars($config_data['smtp_username'] ?? ''); ?>" 
                                               autocomplete="off" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtp_password" class="form-label">
                                            SMTP Password <?php echo $action === 'edit' ? '(leave blank to keep current)' : '*'; ?>
                                        </label>
                                        <input type="password" name="smtp_password" id="smtp_password" class="form-control" 
                                               autocomplete="new-password" <?php echo $action === 'add' ? 'required' : ''; ?>>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">
                            <h6 class="mb-3">Email Settings</h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="from_email" class="form-label">From Email *</label>
                                        <input type="email" name="from_email" id="from_email" class="form-control" 
                                               value="<?php echo htmlspecialchars($config_data['from_email'] ?? ''); ?>" 
                                               placeholder="noreply@example.com" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="from_name" class="form-label">From Name *</label>
                                        <input type="text" name="from_name" id="from_name" class="form-control" 
                                               value="<?php echo htmlspecialchars($config_data['from_name'] ?? ''); ?>" 
                                               placeholder="Your Company Name" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="reply_to_email" class="form-label">Reply-To Email (Optional)</label>
                                        <input type="email" name="reply_to_email" id="reply_to_email" class="form-control" 
                                               value="<?php echo htmlspecialchars($config_data['reply_to_email'] ?? ''); ?>" 
                                               placeholder="support@example.com">
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input type="checkbox" name="is_default" id="is_default" class="form-check-input" 
                                               value="1" <?php echo ($config_data['is_default'] ?? 0) ? 'checked' : ''; ?>>
                                        <label for="is_default" class="form-check-label">
                                            Set as default configuration
                                        </label>
                                        <small class="form-text text-muted d-block">This will be used when no specific configuration is selected</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input type="checkbox" name="is_active" id="is_active" class="form-check-input" 
                                               value="1" <?php echo ($config_data['is_active'] ?? 1) ? 'checked' : ''; ?>>
                                        <label for="is_active" class="form-check-label">
                                            Active
                                        </label>
                                        <small class="form-text text-muted d-block">Only active configurations can be used</small>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <a href="?" class="btn btn-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-save me-1"></i>Save Configuration
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <?php endif; ?>

            </div>
        </div>
    </div>

    <?php include FOOTER; ?>
</body>
</html>