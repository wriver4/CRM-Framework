<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <title>Test Delete Fix</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        rel="stylesheet">
</head>

<body>
  <div class="container mt-4">
    <h1>Test Delete Note Fix</h1>

    <div class="alert alert-info">
      <strong>Testing the 500 Error Fix</strong><br>
      This page tests if the delete_note.php endpoint now returns proper JSON responses instead of 500 errors.
      Open browser developer tools (F12) and watch the Console tab.
    </div>

    <div id="test-results"
         class="mt-4"></div>

    <button type="button"
            class="btn btn-primary"
            onclick="testDeleteEndpoint()">Test Delete Endpoint</button>
    <button type="button"
            class="btn btn-info"
            onclick="testAuthentication()">Test Authentication</button>

    <div class="mt-4">
      <h3>Test Results</h3>
      <div id="results-log"
           class="border p-3 bg-light"
           style="height: 300px; overflow-y: auto;"></div>
    </div>
  </div>

  <script>
    function log (message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('results-log');
      const color = type === 'success' ? 'text-success' : type === 'error' ? 'text-danger' : 'text-info';

      logDiv.innerHTML += `<div class="${color}"><strong>[${timestamp}]</strong> ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;

      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function testDeleteEndpoint () {
      log('üß™ Testing delete endpoint with invalid note ID...', 'info');

      const formData = new FormData();
      formData.append('note_id', 999999);
      formData.append('lead_id', 1);

      fetch('/admin/leads/debug_delete_note.php', {
        method: 'POST',
        body: formData
      })
        .then(response => {
          log(`üì° Response received: ${response.status} ${response.statusText}`, 'info');

          if (response.status === 500) {
            log('‚ùå Still getting 500 error - fix not working', 'error');
            return response.text().then(text => {
              log(`Raw response: ${text.substring(0, 200)}...`, 'error');
            });
          } else if (response.status === 404) {
            log('‚úÖ Got 404 - expected for invalid note ID', 'success');
          } else if (response.status === 401) {
            log('üîê Got 401 - authentication required', 'info');
          } else if (response.status === 200) {
            log('‚úÖ Got 200 - endpoint is working', 'success');
          } else {
            log(`‚ÑπÔ∏è Got ${response.status} - unexpected but not 500`, 'info');
          }

          return response.text();
        })
        .then(text => {
          log(`üìÑ Raw response: ${text.substring(0, 100)}...`, 'info');

          try {
            const data = JSON.parse(text);
            log('‚úÖ Valid JSON response received', 'success');
            log(`üìã Response data: ${JSON.stringify(data)}`, 'info');
          } catch (e) {
            log(`‚ùå Invalid JSON response: ${e.message}`, 'error');
            log(`üìÑ Response was: ${text}`, 'error');
          }
        })
        .catch(error => {
          log(`‚ùå Network error: ${error.message}`, 'error');
        });
    }

    function testAuthentication () {
      log('üîê Testing authentication status...', 'info');

      // Test with GET request (should get 405 Method Not Allowed)
      fetch('/admin/leads/debug_delete_note.php', {
        method: 'GET'
      })
        .then(response => {
          log(`üì° GET request response: ${response.status} ${response.statusText}`, 'info');

          if (response.status === 405) {
            log('‚úÖ Got 405 Method Not Allowed - correct behavior', 'success');
          } else if (response.status === 500) {
            log('‚ùå Still getting 500 error on GET request', 'error');
          } else {
            log(`‚ÑπÔ∏è Unexpected status: ${response.status}`, 'info');
          }

          return response.text();
        })
        .then(text => {
          try {
            const data = JSON.parse(text);
            log('‚úÖ Valid JSON response for GET request', 'success');
            log(`üìã Response: ${JSON.stringify(data)}`, 'info');
          } catch (e) {
            log(`‚ùå Invalid JSON for GET request: ${e.message}`, 'error');
          }
        })
        .catch(error => {
          log(`‚ùå Network error on GET test: ${error.message}`, 'error');
        });
    }

    // Test on page load
    document.addEventListener('DOMContentLoaded', function () {
      log('üöÄ Page loaded - ready to test', 'success');
      log('Click the buttons above to test the delete endpoint', 'info');
    });
  </script>
</body>

</html>